{% extends "base.html" %}

{% block content %}
<script src="https://sdk.mercadopago.com/js/v2"></script>

<div class="form-container my-5">
    <h2 class="text-center">Completa tu pago</h2>
    <div id="paymentBrick_container"></div>
</div>

<script>
  // Inicializar el SDK de Mercado Pago
  const mp = new MercadoPago('TEST-055ecb2c-e0ed-49c3-adf0-f714bc173c3d', {
    locale: 'es-CL', // Cambia según tu localización (es-AR, es-MX, etc.)
    site_id: 'MLC', // Cambia según tu país
  });

  const renderPaymentBrick = async () => {
    const brickContainer = document.getElementById('paymentBrick_container');

    if (!brickContainer) {
      console.error("Contenedor para el Payment Brick no encontrado.");
      return;
    }

    const settings = {
      initialization: {
        preferenceId: "{{ preference_id|escapejs }}", // Asegúrate de que preference_id se pase desde el backend
      },
      callbacks: {
        onReady: () => {
          console.log("El Payment Brick está listo.");
        },
        onSubmit: (formData) => {
          console.log("Datos enviados al servidor:", formData);
          return new Promise((resolve, reject) => {
            fetch('/payment_notification/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(formData),
            })
              .then(response => {
                if (!response.ok) {
                  console.error("Error al procesar el pago.");
                  reject();
                }
                console.log("Pago procesado exitosamente.");
                resolve();
              })
              .catch(error => {
                console.error("Error en la solicitud:", error);
                reject();
              });
          });
        },
        onError: (error) => {
          console.error("Error al procesar el pago:", error);
        },
      },
    };

    const bricksBuilder = mp.bricks();
    await bricksBuilder.create('payment', settings, brickContainer);
  };

  // Renderizar el Payment Brick
  renderPaymentBrick();
</script>

<style>
/* Estilo general para que coincida con la paleta proporcionada */
body {
    background-color: #16161A;
    color: #94A1B2;
    font-family: 'Poppins', sans-serif;
}
.form-container {
    max-width: 600px;
    margin: 0 auto;
    background-color: #16161A;
    padding: 20px;
    border-radius: 10px;
    color: #94A1B2;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
}
h2 {
    color: #7F5AF0;
    font-weight: bold;
    text-align: center;
    margin-bottom: 20px;
}
</style>

{% endblock %}